<!DOCTYPE html>
<meta charset="utf-8">
<style>

@font-face {
    font-family: Akkurat;
    src: url(Akkurat-Normal.otf);
}

@font-face {
font-family: Akkurat-Fett;
src: url(Akkurat-Normal.otf) format("opentype");
}

body{ 
        font-family: Akkurat-Fett;
        margin-left: auto;
        margin-right: auto;
        width:95%;
        background:#303030;
      }
.chart{
      width:100%;
    
}

.selector {
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    font-size:  10pt; 
}


</style>
<body>


<div id = "zone"></div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
            




var indentFromCenter =120;
var indentLastNode = 135;


var width = 1300;//width and height for entire svg chart, margin included
var height = 1300;


var diameter = 1000 - 2* indentFromCenter - 2 *indentLastNode;

var radiuscorretion= 45;
var radius = diameter/2 - radiuscorretion;

var horizontalCorrection = 5;
var verticalCorrection = -1.8;

var tree = d3.layout.tree()
    .size([270+horizontalCorrection, radius])
    .separation(function(a, b) { 
      return (a.parent == b.parent ? 1 : 2) / a.depth;
        //return (a.parent == b.parent ? 1 : 1.5);
    });




var svgtranslate = radius + 2*indentFromCenter+indentLastNode+radiuscorretion;

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("class","chart")
    //.style('background','#FFFFFF')
    .append("g")
    .attr("transform", "translate("+svgtranslate+","+svgtranslate+")rotate("+verticalCorrection+")")

   

//rotate(" + (d.x - 90 ) + ")translate(" + d.y + ")"
 d3.json("origin.json", function(error, data) {

  var nodes = tree.nodes(data);

  var links = tree.links(nodes);
  
  //i basically spent two days trying out to figure out how to make the links
  //straight
  
  var diagonal = d3.svg.diagonal.radial()
    .projection( function (d) {return [d.y + indentFromCenter, d.x/180*Math.PI];})
    

  var link = svg.selectAll(".link")
        .data(links)
        .enter()
        .append("path")
        .attr("class", "link")
        .attr("d",diagonal)
        .attr('fill','none')
        .attr('stroke-width',function(d){
          return  d.source.name=='God'?'0px':'1px';
        })
        .attr('stroke','#484848')





  var node = svg.selectAll(".node")
      .data(nodes)
      .enter()
      .append("g")
      .attr("class", "node")
      .attr("transform", function(d,i) {
          var translatey;

          if (d.depth>0&&d.depth<20){
            translatey = d.y+indentFromCenter;
          }
          else{
              translatey=d.y;
          }
           if(d.depth>19){

             translatey = d.y + indentFromCenter+indentLastNode;
           }
          

          // var translatey = (d.depth>0)? d.y+indentFromCenter : d.y;
          return "rotate(" + (d.x - 90 ) + ")translate(" + translatey + ")";
       });


  



  //CREATING CIRCULAR GRID
   var depthArray=[];

 
   for(var i=0;i<nodes.length;i++){
    depthArray.push(nodes[i].depth);
   }
   function getMax(array){
    return Math.max.apply(Math,array);
  }

  var depthWidth=getMax(depthArray);

  //INSERT GRID FOR NODE #1-19 INCLUSIVE
   for(var i =0;i<depthWidth-1;i++){
      svg.insert('circle','.node')//insert before .node so it is below the node
          .attr('r',function(d){
            // console.log((radius)/depthWidth*(i+1)+indentFromCenter)
            return (radius)/depthWidth*(i+1)+indentFromCenter;
          })
          .style('fill','none')
          .attr('stroke','#606060')
          .attr('class','grid')
   }

   //INSERT GRID FOR #20 node
   svg.insert('circle','.node')
        .attr('r',(radius)/depthWidth*20+indentFromCenter+indentLastNode)
        .style('fill','none')
        .attr('stroke','#606060')
        .attr('class','grid')


  var dotRadius = 11.577/2;
  var dotReducer = 1.5;

  var dots = [
    {'color':'none','isfull':'0'},

    {'color':'#FFFFFF','isfull':'1'},
    {'color':'#90D7F1','isfull':'0'},//2,empty dot 
    {'color':'#90D7F1','isfull':'1'},
    {'color':'#00ADEF','isfull':'1'},
    {'color':'#2F7FC2','isfull':'0'},//5

    {'color':'#2F7FC2','isfull':'1'},
    {'color':'#8D54A1','isfull':'1'},
    {'color':'#BD74B0','isfull':'0'},//8
    {'color':'#BD74B0','isfull':'1'},
    {'color':'#EC008B','isfull':'0'},//10

    {'color':'#EC008B','isfull':'1'},
    {'color':'#F15E38','isfull':'0'},//12
    {'color':'#F15E38','isfull':'1'},
    {'color':'#F9A445','isfull':'1'},
    {'color':'#FFF100','isfull':'0'},//15

    {'color':'#FFF100','isfull':'1'},
    {'color':'#BCD530','isfull':'1'},
    {'color':'#38B449','isfull':'0'},//18
    {'color':'#38B449','isfull':'1'},  //19th: last one for the kind

  ];

  
  node.append('circle')
    .attr('r',function(d,i){

        //if value is 1 and not parent node
        if(d.value!=0 && d.depth!= 0 && d.depth<20){

            return  dots[d.depth].isfull==0? dotRadius - dotReducer: dotRadius;
        }
        else if(d.depth ==20){

          //for later uses.
            return '0';
        }
        

    })
    .style('fill',function(d,i){
         if(d.value!=0 && d.depth!= 0 && d.depth<20){

            return dots[d.depth].isfull==0? '#303030' :dots[d.depth].color;
         }
    })
    .attr('stroke-width',function(d){
        if(d.value!=0 && d.depth!= 0 && d.depth<20){
          return dots[d.depth].isfull==0? 2 * dotReducer :'0';
        }
    })
    .attr('stroke',function(d){
        if(d.value!=0 && d.depth!= 0 && d.depth<20){
          return dots[d.depth].isfull==0? dots[d.depth].color : 'none';
        }
    })


    //APPEND NAMES
    function appendName(){
    node.append("text")
        .attr("dy", ".81em")
        .attr("font-family","Akkurat-Fett")
        .attr("font-size","7.5pt")
        .style("fill","#FFFFFF")
        .attr("text-anchor", function(d) {

         return d.x < 180 ? "start" : "end";
        })
        .attr("transform", function(d) { 
          return d.x < 180 ? "translate(20,-5)" : "rotate(180)translate(-20,-5)"; 
        })
        .text(function(d) {
          if(d.depth==19){
              return d.firstname + " "+ d.lastname;
          }

       });
    }

    appendName();
    

    //DRAW REGIONS CIRCLES
    var regions=[
      {"scale":"global","color": "#8D54A1","radius":"18.6"},//7 global
      {"scale":"country","color": "#4D62AD","radius":"16.4"},//6
      {"scale":"region","color": "#00ADEF","radius":"14.2"},//
      {"scale":"state","color": "#EC008B","radius":"12"},
      {"scale":"city","color": "#F15E38","radius":"9.8"},
      {"scale":"community","color": "#F9A445","radius":"7.6"},//2
      {"scale":"organization","color": "#FFF100","radius":"5.4"},//1
      {"scale":"individual","color": "#FFFFFF","radius":"3.2"},//0 individual

    ]
    
    //DRAW GLOBAL CIRCLE
    node.append("circle")
      .attr("r",function(d){
        if(d.depth==20){
          return d.global==1? regions[0].radius: 0 ;}
      })
      .attr('stroke',function(d){
          if(d.depth==20){
          return d.global==1? regions[0].color: 0 ;}
      })
      .attr('fill','#303030')

      //DRAW COUNTRY CIRCLE
      node.append("circle")
      .attr("r",function(d){
        if(d.depth==20){
          return d.country==1? regions[1].radius: 0 ;}
      })
      .attr('stroke',function(d){
          if(d.depth==20){
          return d.country==1? regions[1].color: 0 ;}
      })
      .attr('fill','#303030')

      //DRAW REGION CIRCLE
      node.append("circle")
      .attr("r",function(d){
        if(d.depth==20){
          return d.region==1? regions[2].radius: 0 ;}
      })
      .attr('stroke',function(d){
          if(d.depth==20){
          return d.region==1? regions[2].color: 0 ;}
      })
      .attr('fill','#303030')

      //DRAW STATE CIRCLE
      node.append("circle")
      .attr("r",function(d){
        if(d.depth==20){
          return d.state==1? regions[3].radius: 0 ;}
      })
      .attr('stroke',function(d){
          if(d.depth==20){
          return d.state==1? regions[3].color: 0 ;}
      })
      .attr('fill','#303030')

      //DRAW CITY CIRCLE
      node.append("circle")
      .attr("r",function(d){
        if(d.depth==20){
          return d.city==1? regions[4].radius: 0 ;}
      })
      .attr('stroke',function(d){
          if(d.depth==20){
          return d.city==1? regions[4].color: 0 ;}
      })
      .attr('fill','#303030')

      //DRAW COMMUNITY CIRCLE
      node.append("circle")
      .attr("r",function(d){
        if(d.depth==20){
          return d.community==1? regions[5].radius: 0 ;}
      })
      .attr('stroke',function(d){
          if(d.depth==20){
          return d.community==1? regions[5].color: 0 ;}
      })
      .attr('fill','#303030')

      //DRAW ORGANIZATION CIRCLE
      node.append("circle")
      .attr("r",function(d){
        if(d.depth==20){
          return d.organization==1? regions[6].radius: 0 ;}
      })
      .attr('stroke',function(d){
          if(d.depth==20){
          return d.organization==1? regions[6].color: 0 ;}
      })
      .attr('fill','#303030')

      //DRAW INDIVIDUAL CIRCLE
      node.append("circle")
      .attr("r",function(d){
        if(d.depth==20){
          return d.individual==1? regions[7].radius: 0 ;}
      })
      .attr('stroke',function(d){
          if(d.depth==20){
          return d.individual==1? regions[7].color: 0 ;}
      })
      .attr('fill','#FFFFFF')
 
      //-====================================================
      //APPEND TERMS
      //====================================================
      var terms =[
        {"color":"#087F9A"},//long, termIndex =0
        {"color":"#00ADEF"},//medium
        {"color":"#A6DDF0"},//short
      ]
      var termDotRadius = 2.8;

      function appendTermDots(termIndex,gap,id){
        node.append("circle")
        .style("fill",function(d){
            if(d.depth==20){
              //return only if id matches..id is in the parent node
            return d.parent.id==id? terms[termIndex].color:'none';
          }
        })
        .attr("r",function(d){
            if(d.depth==20){

                  return d.parent.id==id? termDotRadius: 0;

            }
        })
        .attr("transform", function(d) { 
          

          return d.x < 180 ? "translate("+gap+",0)" : "rotate(180)translate(-"+gap+",0)"; 
        })

      }

      function appendLong(startDistance,id){

        appendTermDots(0,startDistance+5,id)
        appendTermDots(0,startDistance+15,id)
        appendTermDots(0,startDistance+25,id)
        appendTermDots(0,startDistance+35,id)
        appendTermDots(0,startDistance+45,id)
        appendTermDots(0,startDistance+55,id)
      }

      function appendMedium(startDistance,id){

        appendTermDots(1,startDistance+5,id)
        appendTermDots(1,startDistance+15,id)
        appendTermDots(1,startDistance+25,id)
        appendTermDots(1,startDistance+35,id)
      }

      function appendShort(startDistance,id){

        appendTermDots(2,startDistance+5,id)
        appendTermDots(2,startDistance+15,id)
      }
     var gapBetweenTerms = 31,
         beginningDistance = 25;

    function appendAll(node){
      // var getId = node.id;

      var getIndex = node.parent.id;

      
      if(node.long==1&&node.medium==1&&node.short==1){
        appendShort(beginningDistance,getIndex)
        appendMedium(beginningDistance+gapBetweenTerms,getIndex)
        appendLong(beginningDistance+2.5*gapBetweenTerms,getIndex)
      }

      else if(node.long==1&&node.medium==1){
        
        appendMedium(beginningDistance,getIndex)
        appendLong(beginningDistance+1.6*gapBetweenTerms,getIndex)
      }
      else if(node.medium==1&&node.short==1){
         appendShort(beginningDistance,getIndex)
         appendMedium(beginningDistance+gapBetweenTerms,getIndex)

      }
      else if(node.long==1&&node.short==1){
        appendShort(beginningDistance,getIndex)
        appendLong(beginningDistance+gapBetweenTerms,getIndex)

      }

      else if(node.long==1){
        appendLong(beginningDistance,getIndex)
      }
      else if(node.medium==1){
        appendMedium(beginningDistance,getIndex)
      }
      else if(node.short==1){
        appendShort(beginningDistance,getIndex)
      }

      
      
    }
    
    
    for(var i=20;i<nodes.length;i+=20){
        appendAll(nodes[i])
    }

    //==========================END OF APPENDING TERMS==========================
    

    //==========================ANIMATION==========================  ^O^


    var tooltip = d3.select("body").append("div")
          .style("position","absolute")
          .style("padding","0 10px")
          .style("background","white")
          .attr("class","selector")
          .style("opacity",0)


    node.on("mouseover",function(d,i){

        tooltip.transition()
          .style("opacity",.7)

        var tooltiptext=[];

        function insertLineBreak(regionarray){
          if(regionarray.length>3){
            return "<br";
          }
        }
        if(d.depth<19){
          tooltiptext=d.name;
          tooltip.html(tooltiptext)
          .style('left',(d3.event.pageX +10 ) + 'px')
          .style('top', (d3.event.pageY ) + 'px')
         
          ;
        }
        else if (d.depth==20){
            if(d.individual==1){
              tooltiptext.push("individual<br>")
            }
            if(d.organization==1){
              tooltiptext.push("organization<br>")
            }
            if(d.community==1){
              tooltiptext.push("community<br>")
            }
            if(d.city==1){
              tooltiptext.push("city<br>")
            }
            if(d.state==1){
              tooltiptext.push("state<br>")
            }
            if(d.region==1){
              tooltiptext.push("region<br>")
            }
            if(d.country==1){
              tooltiptext.push("country<br>")
            }
            if(d.global==1){
              tooltiptext.push("global<br>")
            }
            tooltip.html(tooltiptext.join(" "))
                .style('left',(d3.event.pageX +10 ) + 'px')
                .style('top', (d3.event.pageY ) + 'px')
                ;
        }

        //MAKE DOTS BIGGER 
        if(d.depth>0 && d.value==1){

          //INCREASE THE RADIUS
          if(d.depth<20){
            d3.select(this).select('circle')
              .transition()
              .duration(120)
              .style('cursor','none')
              .attr('r',function(d){
                return dots[d.depth].isfull==0? dotRadius + 1.5 : dotRadius + 3;
              })

          }

      

        }})
        //when mouse move out, smake dots original size
        .on("mouseout",function(d,i){

          tooltip.html("")
          if(d.depth>0 && d.value==1){
            if(d.depth<20){
                d3.select(this).select('circle')
                  .transition()
                  .duration(250)
                  .style('cursor','none')
                  .attr('r',function(d){
                    return dots[d.depth].isfull==0? dotRadius - dotReducer : dotRadius;
          
                  })
              }

          }
        })


      //========================
      //============MAKE ONE THIRD QUATRE OPAQUE


      var vis = d3.select("body").append("svg")
      var pi = Math.PI;
      
      var arcRotation = 270 - verticalCorrection;
      var arc = d3.svg.arc()
          .innerRadius(indentFromCenter+10)
          .outerRadius(310)
          .startAngle(0) //converting from degs to radians
          .endAngle(pi/2) //just radians
          
      // Added height and width so arc is visible
          svg.insert("path",".node")
          .attr("d", arc)
          .attr("fill", "#303030")
          .style("opacity",0.8)
          .attr("transform","rotate("+arcRotation+")")


      //APPEND DEPARTMENT ARCS
      var departmentColor = [
         {"color":"#3D7B93","angle":"","ends":"Pitt"},
         {"color":"#80A9BC","angle":"","ends":"Hobbie"},
         {"color":"#BAD8E5","angle":"","ends":"Martin"},
         {"color":"#B5B381","angle":"","ends":"Snyder"},
         {"color":"#878737","angle":"","ends":"Uggen"},
         {"color":"#656229","angle":"","ends":"Pelican"},
         {"color":"#58585B","angle":"","ends":"Benjaafar"},
         {"color":"#808284","angle":"","ends":"Matson"},
         {"color":"#A7A9AB","angle":"","ends":"Ramaswami"},
         {"color":"#FFFFFF","angle":"","ends":"Gunn"},
         {"color":"#E17933","angle":"","ends":"Convertino"},
         {"color":"#B45626","angle":"","ends":"Pawlisch"},
         {"color":"#9A3020","angle":"","ends":"RT Rybak"},
         {"color":"#624E11","angle":"","ends":"Chapman"}

      ]

      for(var i =1;i<400;i++){
        if(nodes[i].lastname!=null){
        var getangle = Math.tan(nodes[i].x/nodes[i].y)
        console.log(nodes[i].lastname + " " +getangle)
      }
      }
     

      //=================================================
      //ADDING LEGEND ====================================
      //====================================

      var fieldData=[];
      for(var i = 1; i<20 ;i++){
        fieldData.push(nodes[i].name)
      }



      var textIndent = - 55;
      var textHeightCorrection = -4;
      var circleHeightCorrection =10;

      var smallRadius = dotRadius - 2.5 ;
      var samllDotReducer = dotReducer -1;
      for(var i =0; i <depthWidth  ; i++){

      // console.log(fieldData[i].name)
      
          svg.append("text")
            .attr("dy", ".81em")
            .attr("font-family","Akkurat-Fett")
            .attr("font-size","6.6pt")
            .style("fill","#BBBDC0")
            .attr("text-anchor","end")
            .text(fieldData[i])
            .attr("x",textIndent)
            .attr("y",-(radius)/depthWidth*(i+1)-indentFromCenter + textHeightCorrection)
            .attr("transform","rotate("+(-verticalCorrection)+")")

          var index =!19? i+1: i;

          svg.append("circle")
            .attr('r',function(){
              //return smallRadius;
              return dots[index].isfull==0? smallRadius - samllDotReducer: smallRadius;
            })
            .attr('cx',textIndent+25)
            .attr('cy',-(radius)/depthWidth*(i+1)-indentFromCenter + circleHeightCorrection )
            .attr("transform","rotate("+(-verticalCorrection)+")")
            .style('fill',function(d,i){

                return dots[index].isfull==0? '#303030' :dots[index].color;
           
              })
              .attr('stroke-width',function(d){
                    return dots[index].isfull==0? 2 * samllDotReducer :'0';
                  
              })
              .attr('stroke',function(d){
                    return dots[index].isfull==0? dots[index].color : 'none';
                  
              })

      }

      var regionData = [];

      var regionIndentY = -265;
      //APPEND REGION LEGEND
      for (var i =0;i<8;i++){

        svg.append("text")
            .attr("dy", ".81em")
            .attr("font-family","Akkurat-Fett")
            .attr("font-size","6.6pt")
            .style("fill","#BBBDC0")
            .attr("text-anchor","end")
            .text(regions[i].scale)
            .attr("x",textIndent)
            .attr("y",-(radius)/depthWidth*(i+1)-indentFromCenter + textHeightCorrection +regionIndentY )
            .attr("transform","rotate("+(-verticalCorrection)+")")

        svg.append("circle")
            .attr('r',smallRadius)
            .attr('cx',textIndent+25)
            .attr('cy',-(radius)/depthWidth*(i+1)-indentFromCenter + circleHeightCorrection +regionIndentY - 9.4 )
            .attr("transform","rotate("+(-verticalCorrection)+")")
            .style('stroke',function(){

                return regions[i].color;
           
              })
            .style('fill','#303030')


      }

      var termData = [
        {"term":"short term (<1 yr)","color":"#A6DDF0"},
        {"term":"medium term (1 - 10 yr)","color":"#00ADEF"},
        {"term":"long term (10+ yr)","color":"#087F9A"}
      ]

      //

      var termIndentY = -120;

      function drawDot(horizontalGap,verticalGap,color){
          svg.append("circle")
            .attr('r',2)
            .attr('cx',textIndent+25+horizontalGap)
            .attr('cy',-(radius)/depthWidth*(i+1)-indentFromCenter + circleHeightCorrection +regionIndentY - 9.4 + verticalGap)
            .attr("transform","rotate("+(-verticalCorrection)+")")
            .style('fill',function(){

                return color;
              })
      }
      var shorty= -80;
      var mediumy= -90;
      var longy = -100;

      function drawShort(){
        drawDot(8,shorty,termData[0].color)
        drawDot(0,shorty,termData[0].color)

      }
      function drawMedium(){
        drawDot(24,mediumy,termData[1].color)
        drawDot(16,mediumy,termData[1].color)
        drawDot(8,mediumy,termData[1].color)
        drawDot(0,mediumy,termData[1].color)
      }
      function drawLong(){
        drawDot(40,longy,termData[2].color)
        drawDot(32,longy,termData[2].color)
        drawDot(24,longy,termData[2].color)
        drawDot(16,longy,termData[2].color)
        drawDot(8,longy,termData[2].color)
        drawDot(0,longy,termData[2].color)


      }

      drawShort()
      drawMedium()
      drawLong()

      for(var i =0;i<3;i++){
        svg.append("text")
            .attr("dy", ".81em")
            .attr("font-family","Akkurat-Fett")
            .attr("font-size","6.6pt")
            .style("fill","#BBBDC0")
            .attr("text-anchor","end")
            .text(termData[i].term)
            .attr("x",textIndent)
            .attr("y",-(radius)/depthWidth*(i+1)-indentFromCenter + textHeightCorrection +regionIndentY +termIndentY)
            .attr("transform","rotate("+(-verticalCorrection)+")")

      }

 

});

d3.select(self.frameElement).style("height", diameter - 150 + "px");

</script>